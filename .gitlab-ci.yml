## TODO: Modularize the gitlab yaml to reuse templates

## Define the stages & order of execution
lock: $CI_ENVIRONMENT_NAME

stages:
  - CLUSTER-SETUP
  - PROVIDER-INFRA-SETUP
  - CHAOS
  - CLUSTER-CLEANUP

variables: 
  utils_path: "/builds/openebs/e2e-packet/script/utils"

# Setup the kubernetes cluster

packet-cluster:
  image: chandankumar4/packet:v4
  stage: CLUSTER-SETUP
  tags: 
    - k8s-1-16 
  script:
    - chmod 755 ./script/1-cluster-setup/packet
    - ./script/1-cluster-setup/packet
  artifacts:
    paths:
      - cluster/

## Setup OpenEBS control plane

openebs-deploy:
  image: atulabhi/kops:v8
  stage: PROVIDER-INFRA-SETUP
  tags: 
    - k8s-1-16
  dependencies:
    - packet-cluster
  script: 
   - chmod 775 ./script/2-infra-setup/openebs-deploy/deploy-openebs
   - ./script/2-infra-setup/openebs-deploy/deploy-openebs
  artifacts:
    paths:
      - openebs-packet/

openebs-sc-deploy:
  image: atulabhi/kops:v8
  stage: PROVIDER-INFRA-SETUP
  tags: 
    - k8s-1-16
  dependencies:
    - packet-cluster
  script:
   - chmod 775 ./script/2-infra-setup/setup-sc/openebs-sc
   - ./script/2-infra-setup/setup-sc/openebs-sc
  artifacts:
    paths:
      - openebs-packet/

Create-striped-pool:
  image: atulabhi/kops:v8
  stage: PROVIDER-INFRA-SETUP
  tags: 
    - k8s-1-16
  dependencies:
    - packet-cluster
  script:
   - chmod 775 ./script/2-infra-setup/create-striped-pool/create-striped-pool
   - ./script/2-infra-setup/create-striped-pool/create-striped-pool
  artifacts:
    paths:
      - openebs-packet/

.chaos_test_template:
  image: atulabhi/kops:v8
  stage: CHAOS
  tags: 
    - k8s-1-16
  when: always
  dependencies:
    - openebs-deploy
  artifacts:
    paths:
      - openebs-packet/  

App-Kill:
  extends: .chaos_test_template
  script: 
    - chmod 775 ./script/4-chaos/App-Kill/app-kill
    - ./script/4-chaos/App-Kill/app-kill

cStor-istgt-Kill:
  extends: .chaos_test_template
  script: 
    - chmod 775 ./script/4-chaos/Cstor-volume-istgt-kill/cstor-volume-istgt-kill
    - ./script/4-chaos/Cstor-volume-istgt-kill/cstor-volume-istgt-kill

cStor-Pool-Kill:
  extends: .chaos_test_template
  script: 
    - chmod 775 ./script/4-chaos/Cstor-pool-kill/cstor-pool-kill
    - ./script/4-chaos/Cstor-pool-kill/cstor-pool-kill

cStor-Pool-Delete:
  extends: .chaos_test_template
  script:
    - chmod 775 ./script/4-chaos/Cstor-pool-delete/cstor-pool-delete
    - ./script/4-chaos/Cstor-pool-delete/cstor-pool-delete

cStor-target-kill:
  extends: .chaos_test_template
  script: 
    - chmod 775 ./script/4-chaos/Target-Kill/target-kill
    - ./script/4-chaos/Target-Kill/target-kill

Target-Network-Delay:
  extends: .chaos_test_template
  script: 
    - chmod 775 ./script/4-chaos/Target-Network-Delay/target-network-delay
    - ./script/4-chaos/Target-Network-Delay/target-network-delay

Target-Network-Loss:
  extends: .chaos_test_template
  script: 
    - chmod 775 ./script/4-chaos/Target-Network-Loss/target-network-loss
    - ./script/4-chaos/Target-Network-Loss/target-network-loss

Snap-Rebuild-single-replica:
  extends: .chaos_test_template
  script: 
    - chmod 775 ./script/4-chaos/Snap-Rebuild-Single-Rep/snap-rebuild-single-rep
    - ./script/4-chaos/Snap-Rebuild-Single-Rep/snap-rebuild-single-rep

Snap-Rebuild-multiple-replica:
  extends: .chaos_test_template
  script: 
    - chmod 775 ./script/4-chaos/Snap-Rebuild-Multiple-Replica/snap-rebuild-multiple-replica
    - ./script/4-chaos/Snap-Rebuild-Multiple-Replica/snap-rebuild-multiple-replica

Clone-Rebuild-post-snapshot-rebuild:
  extends: .chaos_test_template
  script: 
    - chmod 775 ./script/4-chaos/Clone-Post-Snap-Rebuild/clone-post-rebuild
    - ./script/4-chaos/Clone-Post-Snap-Rebuild/clone-post-rebuild

volume-mgmt-kill:
  extends: .chaos_test_template
  script: 
    - chmod 775 ./script/4-chaos/Cstor-volume-mgmt-kill/cstor-volume-mgmt-kill
    - ./script/4-chaos/Cstor-volume-mgmt-kill/cstor-volume-mgmt-kill

Jiva-App-Kill:
  extends: .chaos_test_template
  script:
    - chmod 775 ./script/4-chaos/Jiva-app-kill/jiva-app-kill
    - ./script/4-chaos/Jiva-app-kill/jiva-app-kill

Jiva-single-replica-failure:
  extends: .chaos_test_template
  script:
    - chmod 775 ./script/4-chaos/Jiva-single-replica-failure/single-replica-failure
    - ./script/4-chaos/Jiva-single-replica-failure/single-replica-failure

Jiva-replica-failure:
  extends: .chaos_test_template
  script:
    - chmod 775 ./script/4-chaos/Jiva-replica-failure/jiva-replica-failure
    - ./script/4-chaos/Jiva-replica-failure/jiva-replica-failure

Jiva-replica-node-affinity:
  extends: .chaos_test_template
  script:
    - chmod 775 ./script/4-chaos/Jiva-replica-node-affinity/replica-node-affinity
    - ./script/4-chaos/Jiva-replica-node-affinity/replica-node-affinity

      ############# cleanup stage ##############
cleanup-packet:
  when: always
  image: chandankumar4/packet:v4
  dependencies:
    - packet-cluster
  stage: CLUSTER-CLEANUP
  tags: 
    - k8s-1-16
  script: 
    - chmod 755 ./script/5-cleanup/packet-cleanup
    - ./script/5-cleanup/packet-cleanup
