## TODO: Modularize the gitlab yaml to reuse templates

## Define the stages & order of execution

stages:
  - CLUSTER-SETUP
  - PROVIDER-INFRA-SETUP
  # - PROVISIONER-SETUP  
  # - STATEFUL-APP-DEPLOY
  # - APP-FUNC-TEST
  # - APP-CHAOS-TEST
  # - APP-DEPROVISION
  - CLUSTER-CLEANUP

variables: 
  utils_path: "/builds/openebs/e2e-packet/script/utils"

# Setup the kubernetes cluster

packet-cluster:
  image: chandankumar4/packet:v4
  stage: CLUSTER-SETUP
  tags: 
    - k8s-1-16 
  script:
    - mkdir -p ~/.ssh && ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa
    - echo -e "Host *\nStrictHostKeyChecking no" > ~/.ssh/config
    - chmod 755 ./script/1-cluster-setup/packet
    - ./script/1-cluster-setup/packet
  artifacts:
    paths:
      - cluster/

## Setup OpenEBS control plane

openebs-deploy:
  image: atulabhi/kops:v8
  stage: PROVIDER-INFRA-SETUP
  tags: 
    - k8s-1-16
  dependencies:
    - packet-cluster
  script: 
   - chmod 775 ./script/2-infra-setup/openebs-deploy/deploy-openebs
   - ./script/2-infra-setup/openebs-deploy/deploy-openebs
  artifacts:
    paths:
      - openebs-packet/

openebs-sc-deploy:
  image: atulabhi/kops:v8
  stage: PROVIDER-INFRA-SETUP
  tags: 
    - k8s-1-16
  dependencies:
    - packet-cluster
  script:
   - chmod 775 ./script/2-infra-setup/setup-sc/openebs-sc
   - ./script/2-infra-setup/setup-sc/openebs-sc
  artifacts:
    paths:
      - openebs-packet/

Create-striped-pool:
  image: atulabhi/kops:v8
  stage: PROVIDER-INFRA-SETUP
  tags: 
    - k8s-1-16
  dependencies:
    - packet-cluster
  script:
   - chmod 775 ./script/2-infra-setup/create-striped-pool/create-striped-pool
   - ./script/2-infra-setup/create-striped-pool/create-striped-pool
  artifacts:
    paths:
      - openebs-packet/

      # cleanup stage
cleanup-packet:
  when: always
  image: chandankumar4/packet:v4
  dependencies:
    - packet-cluster
  stage: CLUSTER-CLEANUP
  tags: 
    - k8s-1-16
  script: 
    - chmod 755 ./script/5-cleanup/packet-cleanup
    - ./script/5-cleanup/packet-cleanup
